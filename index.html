<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CIE-297 | Monitoreo en Tiempo Real</title>
  <link rel="icon" href="assets/logo.png" />

  <!-- Leaflet (solo si vas a usar el mapa) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --bg:#0b1424;--card:#101b31;--soft:#12213b;--text:#e5ecff;--muted:#93a4c7;
      --ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--line:rgba(255,255,255,.08);
      --chip:#152238;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
    h1{font-size:22px;margin:0 0 8px}
    h2{font-size:18px;margin:12px 0}
    label{display:block;font-size:14px;margin:10px 0 6px}
    input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0e1a31;color:var(--text)}
    textarea{min-height:84px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .mt{margin-top:14px}
    .btn{cursor:pointer;border:1px solid var(--line)}
    .btn-ok{background:var(--ok);color:#08120b;border:none}
    .btn-warn{background:var(--warn);color:#1b1207;border:none}
    .btn-danger{background:var(--danger);color:#220b0b;border:none}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:12px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hide{display:none}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px;vertical-align:top}
    th{text-align:left;color:var(--muted)}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .center{text-align:center}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .topbar img{height:36px}
    .link{cursor:pointer;text-decoration:underline}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:880px){.row,.row3,.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="flex">
        <img src="assets/logo.png" alt="CIE-297" />
        <div>
          <div class="chip">CIE-297</div>
          <div class="muted" style="font-size:12px;margin-top:4px">Monitoreo en tiempo real</div>
        </div>
      </div>
      <div id="sessionBox" class="flex">
        <span id="whoami" class="muted"></span>
        <button class="btn" id="btnLogout" onclick="logout()" title="Cerrar sesión">Salir</button>
      </div>
    </div>

    <!-- Auth -->
    <div id="auth" class="grid">
      <div class="card">
        <h1>Iniciar sesión</h1>
        <label>Email</label>
        <input id="loginEmail" type="email" placeholder="usuario@cie297.mil" />
        <label>Contraseña</label>
        <input id="loginPass" type="password" placeholder="••••••" />
        <button class="btn btn-ok mt" onclick="doLogin()">Entrar</button>
        <p class="muted mt">
          Tips: existen usuarios de prueba<br/>
          <code>admin@cie297.mil / 123456</code> (Admin)<br/>
          <code>user@cie297.mil / 123456</code> (Operador)
        </p>
      </div>

      <div class="card">
        <h1>Crear cuenta</h1>
        <div class="row">
          <div>
            <label>Nombre</label>
            <input id="regNombre" placeholder="Nombre y apellido" />
          </div>
          <div>
            <label>Email</label>
            <input id="regEmail" type="email" placeholder="nombre@cie297.mil" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Contraseña</label>
            <input id="regPass" type="password" placeholder="••••••" />
          </div>
          <div>
            <label>Repetir contraseña</label>
            <input id="regPass2" type="password" placeholder="••••••" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Grado (WW/W1…W0)</label>
            <select id="regGrado"></select>
          </div>
          <div>
            <label>Fuerza (MA…MF)</label>
            <select id="regFuerza"></select>
          </div>
        </div>
        <button class="btn btn-warn mt" onclick="doRegister()">Registrarme</button>
      </div>
    </div>

    <!-- Panel Usuario -->
    <div id="panelUsuario" class="hide">
      <div class="card">
        <h1>Nuevo reporte</h1>
        <div class="row3">
          <div>
            <label>Nivel</label>
            <select id="repNivel">
              <option value="ALTA">ALTA (CRÍTICO)</option>
              <option value="MEDIA">MEDIA (RELEVANTE)</option>
              <option value="BAJA">BAJA (NO PRIORITARIA)</option>
            </select>
          </div>
          <div>
            <label>Operación</label>
            <input id="repOperacion" placeholder="Ej. Operación Centinela" />
          </div>
          <div>
            <label>País - Ciudad</label>
            <input id="repLugar" placeholder="Bolivia - La Paz" />
          </div>
        </div>
        <label>Detalle</label>
        <textarea id="repDetalle" placeholder="Describe brevemente el evento..."></textarea>
        <button class="btn btn-ok mt" onclick="enviarReporte()">Enviar reporte</button>
      </div>

      <div class="card mt">
        <h2>Alertas (recientes)</h2>
        <div class="muted" style="font-size:13px">Tus reportes más recientes (ordenados con el último primero).</div>
        <table id="tablaAlertas">
          <thead>
            <tr><th>Fecha/Hora</th><th>Nivel</th><th>Operación</th><th>Lugar</th><th>Detalle</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Panel Admin -->
    <div id="panelAdmin" class="hide">
      <div class="card">
        <h1>Panel Administrador</h1>
        <div class="flex">
          <button class="btn btn-ok" onclick="cargarAlertasAdmin()">Ver todas las alertas</button>
          <button class="btn" onclick="cargarAccesos()">Ver accesos</button>
        </div>
      </div>

      <div class="card mt">
        <h2>Alertas</h2>
        <table id="tablaAdminAlertas">
          <thead>
            <tr><th>Fecha/Hora</th><th>Nivel</th><th>Operación</th><th>Lugar</th><th>Detalle</th><th>Usuario</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card mt">
        <h2>Accesos</h2>
        <table id="tablaAccesos">
          <thead>
            <tr><th>Fecha/Hora</th><th>Email</th><th>Nombre</th><th>IP</th><th>Estado</th><th class="right">Acciones</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <p class="center muted mt">© CIE-297</p>
  </div>

  <script>
    // API base: Vercel hará proxy /api → Render (ajustado en vercel.json)
    const API = '/api';

    // --- Helpers sesión ---
    function getToken(){ return localStorage.getItem('token') || ''; }
    function setToken(t){ localStorage.setItem('token', t||''); }
    function setUser(u){ localStorage.setItem('user', JSON.stringify(u||{})); }
    function getUser(){ try{return JSON.parse(localStorage.getItem('user')||'{}')}catch{return{}} }

    function show(id){ document.getElementById(id).classList.remove('hide'); }
    function hide(id){ document.getElementById(id).classList.add('hide'); }

    function toast(msg){ alert(msg); }

    // Combos solicitados
    const GRADOS = ['WW','W1','W2','W3','W4','W5','W6','W7','W8','W9','W0'];
    const FUERZAS = ['MA','MB','MC','MD','ME','MF'];

    function fillSelect(sel, arr){
      sel.innerHTML = '';
      arr.forEach(v=>{
        const o=document.createElement('option');
        o.value=v; o.textContent=v;
        sel.appendChild(o);
      });
    }

    async function doLogin(){
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPass').value;
      if(!email || !password){ return toast('Completa email y contraseña'); }
      try{
        const r = await fetch(`${API}/login`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, password })
        });
        const data = await r.json();
        if(!r.ok) throw new Error(data.message||'Error de login');
        setToken(data.token);
        setUser(data.user||{});
        toast('Sesión iniciada');
        routeByRole();
      }catch(e){ toast(e.message); }
    }

    async function doRegister(){
      const nombre = document.getElementById('regNombre').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const pass = document.getElementById('regPass').value;
      const pass2 = document.getElementById('regPass2').value;
      const grado = document.getElementById('regGrado').value;
      const fuerza = document.getElementById('regFuerza').value;
      if(!nombre || !email || !pass || !pass2){ return toast('Completa todos los campos'); }
      if(pass!==pass2){ return toast('Las contraseñas no coinciden'); }
      try{
        const r = await fetch(`${API}/register`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ nombre, email, password: pass, grado, fuerza })
        });
        const data = await r.json();
        if(!r.ok) throw new Error(data.message||'No se pudo registrar');
        toast('Cuenta creada, ahora inicia sesión.');
      }catch(e){ toast(e.message); }
    }

    function logout(){
      setToken('');
      setUser({});
      location.reload();
    }

    function routeByRole(){
      const u=getUser();
      const who = document.getElementById('whoami');
      const sessionBox = document.getElementById('sessionBox');
      who.textContent = u?.email ? `${u.email} ${u.is_admin?'(Admin)':'(Usuario)'} ` : '';
      if(u?.email){ sessionBox.classList.remove('hide'); } else { sessionBox.classList.add('hide'); }

      hide('auth'); hide('panelUsuario'); hide('panelAdmin');
      if(u?.is_admin){ show('panelAdmin'); cargarAlertasAdmin(); cargarAccesos(); }
      else if(u?.email){ show('panelUsuario'); cargarAlertasUsuario(); }
      else { show('auth'); }
    }

    async function enviarReporte(){
      const nivel = document.getElementById('repNivel').value;
      const operacion = document.getElementById('repOperacion').value.trim();
      const lugar = document.getElementById('repLugar').value.trim();
      const detalle = document.getElementById('repDetalle').value.trim();
      if(!operacion || !lugar || !detalle){ return toast('Completa operación, lugar y detalle'); }
      try{
        const r = await fetch(`${API}/reports`,{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer '+getToken()
          },
          body: JSON.stringify({ nivel, operacion, lugar, detalle })
        });
        const data=await r.json();
        if(!r.ok) throw new Error(data.message||'No se pudo enviar');
        toast('Reporte enviado');
        document.getElementById('repDetalle').value='';
        cargarAlertasUsuario();
      }catch(e){ toast(e.message); }
    }

    function renderTable(tbody, rows){
      tbody.innerHTML='';
      rows.forEach(o=>{
        const tr=document.createElement('tr');
        const td = (v)=>{ const c=document.createElement('td'); c.innerHTML=v; return c; };
        tr.appendChild(td(new Date(o.fecha||o.created_at||Date.now()).toLocaleString()));
        tr.appendChild(td(`<span class="chip">${o.nivel||'-'}</span>`));
        tr.appendChild(td(o.operacion||'-'));
        tr.appendChild(td(o.lugar||'-'));
        tr.appendChild(td(o.detalle||'-'));
        if(o.usuario){
          tr.appendChild(td(`${o.usuario.email||'-'}`));
        }
        tbody.appendChild(tr);
      });
    }

    async function cargarAlertasUsuario(){
      try{
        const r = await fetch(`${API}/admin/alerts`,{ // el backend devuelve todo; filtramos cliente si hace falta
          headers:{'Authorization':'Bearer '+getToken()}
        });
        const data = await r.json();
        if(!r.ok) throw new Error(data.message||'Error al cargar');
        // para usuario mostramos todo igual (o se podría filtrar por email)
        const body = document.querySelector('#tablaAlertas tbody');
        renderTable(body, data.alertas||[]);
      }catch(e){ toast(e.message); }
    }

    async function cargarAlertasAdmin(){
      try{
        const r = await fetch(`${API}/admin/alerts`,{
          headers:{'Authorization':'Bearer '+getToken()}
        });
        const data=await r.json();
        if(!r.ok) throw new Error(data.message||'Error al cargar');
        const body = document.querySelector('#tablaAdminAlertas tbody');
        renderTable(body, data.alertas||[]);
      }catch(e){ toast(e.message); }
    }

    async function cargarAccesos(){
      try{
        const r = await fetch(`${API}/admin/access`,{
          headers:{'Authorization':'Bearer '+getToken()}
        });
        const data=await r.json();
        if(!r.ok) throw new Error(data.message||'Error al cargar accesos');
        const body = document.querySelector('#tablaAccesos tbody');
        body.innerHTML='';
        (data.accesos||[]).forEach(a=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td>${new Date(a.fecha||Date.now()).toLocaleString()}</td>
            <td>${a.email||'-'}</td>
            <td>${a.nombre||'-'}</td>
            <td>${a.ip||'-'}</td>
            <td><span class="chip">${a.estado||'OK'}</span></td>
            <td class="right">
              <button class="btn btn-warn" onclick="bloquearAcceso('${a.email||''}')">Bloquear</button>
              <button class="btn btn-danger" style="margin-left:8px" onclick="eliminarAccesos('${a.email||''}')">Eliminar</button>
            </td>
          `;
          body.appendChild(tr);
        });
      }catch(e){ toast(e.message); }
    }

    async function bloquearAcceso(email){
      if(!email) return;
      try{
        const r = await fetch(`${API}/admin/access/block`,{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer '+getToken()
          },
          body: JSON.stringify({ email })
        });
        if(r.status===404){ toast('El backend aún no implementa /admin/access/block. (No es error)'); return; }
        const data=await r.json();
        if(!r.ok) throw new Error(data.message||'No se pudo bloquear');
        toast('Acceso bloqueado'); cargarAccesos();
      }catch(e){ toast(e.message); }
    }

    async function eliminarAccesos(email){
      if(!email) return;
      try{
        const r = await fetch(`${API}/admin/access`,{
          method:'DELETE',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer '+getToken()
          },
          body: JSON.stringify({ email })
        });
        if(r.status===404){ toast('El backend aún no implementa DELETE /admin/access. (No es error)'); return; }
        const data=await r.json();
        if(!r.ok) throw new Error(data.message||'No se pudo eliminar');
        toast('Accesos eliminados'); cargarAccesos();
      }catch(e){ toast(e.message); }
    }

    // Init
    (function init(){
      // combos de registro
      fillSelect(document.getElementById('regGrado'), GRADOS);
      fillSelect(document.getElementById('regFuerza'), FUERZAS);

      // estado de sesión
      const u=getUser();
      if(!u?.email){
        hide('panelUsuario'); hide('panelAdmin'); show('auth');
        document.getElementById('sessionBox').classList.add('hide');
      }else{
        routeByRole();
      }
    })();
  </script>
</body>
</html>
