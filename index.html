<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CIE-297 | Monitoreo en Tiempo Real</title>
  <link rel="icon" href="assets/logo.png" />

  <!-- PWA (añadido) -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b1424">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">

  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="">
  <script defer
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

  <style>
    :root{
      --bg:#0b1424;--card:#101b31;--text:#e5ecff;--muted:#93a4c7;
      --ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--line:rgba(255,255,255,.08);
      --chip:#152238;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1250px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    h1{font-size:22px;margin:0 0 10px}
    h2{font-size:18px;margin:0 0 10px}
    label{display:block;font-size:14px;margin:10px 0 6px}
    input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0e1a31;color:#e5ecff}
    textarea{min-height:84px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{cursor:pointer;border:1px solid var(--line)}
    .btn-ok{background:var(--ok);color:#08120b;border:none}
    .btn-warn{background:var(--warn);color:#1b1207;border:none}
    .btn-danger{background:var(--danger);color:#220b0b;border:none}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:12px}
    .muted{color:var(--muted)} .hide{display:none}
    table{width:100%;border-collapse:collapse} th,td{padding:9px;border-bottom:1px solid var(--line);font-size:14px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .topbar img{height:36px}
    .top-actions{display:flex;gap:8px}
    .grid2{display:grid;grid-template-columns:2fr 1.2fr;gap:16px}
    #map{width:100%;height:360px;border-radius:14px;border:1px solid var(--line);margin-top:6px}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    @media (max-width:1024px){.grid2,.row,.row3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Topbar -->
    <div class="topbar">
      <div style="display:flex;gap:10px;align-items:center">
        <img src="assets/logo.png" alt="CIE-297"/>
        <div>
          <div class="chip">CIE-297</div>
          <div class="muted" style="font-size:12px;margin-top:2px">Monitoreo en tiempo real</div>
        </div>
      </div>
      <div class="top-actions">
        <button id="btnOperativo" class="btn hide" onclick="showOperativo()">Operativo</button>
        <button id="btnAdmin" class="btn hide" onclick="showAdmin()">Admin</button>
        <div id="sessionBox" class="hide inline">
          <span id="whoami" class="muted"></span>
          <button class="btn" onclick="logout()">Salir</button>
        </div>
      </div>
    </div>

    <!-- LANDING -->
    <div id="auth" class="card">
      <h1>Crear cuenta</h1>
      <div class="row">
        <div>
          <label>Nombre</label>
          <input id="regNombre" placeholder="Nombre y apellido"/>
        </div>
        <div>
          <label>Email</label>
          <input id="regEmail" type="email" placeholder="nombre@cie297.mil"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Contraseña</label>
          <input id="regPass" type="password" placeholder="••••••"/>
        </div>
        <div>
          <label>Repetir contraseña</label>
          <input id="regPass2" type="password" placeholder="••••••"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Grado</label>
          <select id="regGrado"></select>
        </div>
        <div>
          <label>Fuerza</label>
          <select id="regFuerza"></select>
        </div>
      </div>
      <button class="btn btn-warn" style="margin-top:12px" onclick="doRegister()">Registrarme</button>
      <div style="margin-top:12px">
        <span class="muted" style="font-size:13px">¿Ya tienes cuenta?</span>
        <button class="btn" style="margin-left:8px" onclick="toggleLogin(true)">Iniciar sesión</button>
      </div>

      <!-- Login -->
      <div id="loginCard" class="hide" style="margin-top:14px">
        <h2>Iniciar sesión</h2>
        <label>Email</label>
        <input id="loginEmail" type="email" placeholder="usuario@cie297.mil"/>
        <label>Contraseña</label>
        <input id="loginPass" type="password" placeholder="••••••"/>
        <div class="inline" style="margin-top:10px">
          <button class="btn btn-ok" onclick="doLogin()">Entrar</button>
          <button class="btn" onclick="toggleLogin(false)">Ocultar</button>
        </div>
      </div>
    </div>

    <!-- PANEL OPERATIVO -->
    <div id="panelOperativo" class="hide">
      <div class="grid2">
        <div>
          <div class="card">
            <h1>Área Operativa</h1>
            <div id="map"></div>
            <div class="muted" style="font-size:12px;margin-top:6px">
              Ubicaciones de agentes activos (se registra al iniciar sesión).
            </div>
          </div>

          <div class="card" style="margin-top:16px">
            <h2>Misiones y Reportes</h2>
            <div class="row3">
              <div>
                <label>Nivel</label>
                <select id="repNivel">
                  <option value="ALTA">ALTA (CRÍTICO)</option>
                  <option value="MEDIA">MEDIA (RELEVANTE)</option>
                  <option value="BAJA">BAJA (NO PRIORITARIA)</option>
                </select>
              </div>
              <div>
                <label>Operaciones</label>
                <select id="repOperacion"></select>
              </div>
              <div>
                <label>Código indicativo de color</label>
                <select id="repColor">
                  <option>ROJO</option><option>AMARILLO</option><option>VERDE</option>
                  <option>AZUL</option><option>NEGRO</option><option>BLANCO</option>
                </select>
              </div>
            </div>

            <div class="row3">
              <div>
                <label>País / Ciudad</label>
                <input id="repPaisCiudad" placeholder="Bolivia - La Paz"/>
              </div>
              <div>
                <label>Lugar </label>
                <select id="repLugar"></select>
              </div>
              <div>
                <label>Personalidades</label>
                <select id="repPersonalidad"></select>
              </div>
            </div>

            <div class="row3">
              <div>
                <label>Unidad Policial </label>
                <select id="repUnidad"></select>
              </div>
              <div>
                <label>Acciones del oponente </label>
                <select id="repAccionOponente"></select>
              </div>
              <div>
                <label>Material / Equipo </label>
                <select id="repMaterial"></select>
              </div>
            </div>

            <div class="row3">
              <div>
                <label>Transporte </label>
                <select id="repTransporte"></select>
              </div>
              <div>
                <label>Otros</label>
                <select id="repOtros"></select>
              </div>
              <div>
                <label>Clasificación SEG</label>
                <select id="repClasif">
                  <option>SAGITARIO</option><option>TAURO</option>
                  <option>GEMINIS</option><option>ARIES</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Tipo de documento</label>
                <select id="repTipoDoc"></select>
              </div>
              <div>
                <label>Detalle</label>
                <input id="repDetalle" placeholder="Descripción breve del evento"/>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Latitud</label>
                <input id="repLat" type="number" step="any" placeholder="-16.5"/>
              </div>
              <div>
                <label>Longitud</label>
                <input id="repLng" type="number" step="any" placeholder="-68.15"/>
              </div>
            </div>

            <div class="inline" style="margin-top:6px">
              <button class="btn" id="btnUbicacion" onclick="usarMiUbicacion()">Usar mi ubicación</button>
              <span class="muted" style="font-size:12px">Se llenarán Lat/Lng al aceptar permisos.</span>
            </div>

            <button class="btn btn-ok" style="margin-top:12px" onclick="enviarReporte()">Enviar alerta</button>
          </div>
        </div>

        <div>
          <div class="card">
            <div class="inline">
              <button class="btn btn-ok" onclick="cargarAlertasUsuario()">Ver todas</button>
              <button class="btn" onclick="exportarPDF()">Exportar PDF</button>
              <button class="btn" onclick="cargarAccesos()">Accesos</button>
            </div>
          </div>

          <div class="card" style="margin-top:16px">
            <h2>Alertas</h2>
            <div id="feedAlertas" class="muted" style="max-height:420px;overflow:auto"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h2>Alertas (tabla)</h2>
        <table id="tablaAlertas">
          <thead>
            <tr>
              <th>Fecha/Hora</th><th>Nivel</th><th>Operación</th><th>País/Ciudad</th>
              <th>Lugar</th><th>Clasif</th><th>Lat</th><th>Lng</th><th>Detalle</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- PANEL ADMIN -->
    <div id="panelAdmin" class="hide">
      <div class="card">
        <h1>Panel Administrador</h1>
        <div class="inline">
          <button class="btn btn-ok" onclick="cargarAlertasAdmin()">Ver todas las alertas</button>
          <button class="btn" onclick="exportarPDF()">Exportar PDF</button>
          <button class="btn" onclick="cargarAccesos()">Ver accesos</button>
          <button class="btn" onclick="showOperativo()">Volver a Operativo</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h2>Alertas</h2>
        <table id="tablaAdminAlertas">
          <thead>
            <tr>
              <th>Fecha/Hora</th><th>Nivel</th><th>Operación</th><th>País/Ciudad</th>
              <th>Lugar</th><th>Clasif</th><th>Lat</th><th>Lng</th><th>Detalle</th><th>Usuario</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:16px">
        <h2>Accesos</h2>
        <table id="tablaAccesos">
          <thead>
            <tr><th>Fecha/Hora</th><th>Email</th><th>Nombre</th><th>IP</th><th>Estado</th><th style="text-align:right">Acciones</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <p class="muted" style="text-align:center;margin-top:16px">© CIE-297</p>
  </div>

  <script>
    const API = '/api';
    const $ = id => document.getElementById(id);

    // ===== Helpers sesión
    function getToken(){ return localStorage.getItem('token')||''; }
    function setToken(v){ localStorage.setItem('token', v||''); }
    function setUser(u){ localStorage.setItem('user', JSON.stringify(u||{})); }
    function getUser(){ try{return JSON.parse(localStorage.getItem('user')||'{}')}catch{return{}} }
    function toast(m){ alert(m); }
    function show(id){ $(id).classList.remove('hide'); }
    function hide(id){ $(id).classList.add('hide'); }
    function toggleLogin(on){ $('loginCard').classList.toggle('hide', !on); }

    // ===== Catálogos
    const GRADOS=['WW','W1','W2','W3','W4','W5','W6','W7','W8','W9','W0'];
    const FUERZAS=['MA','MB','MC','MD','ME','MF'];
    const OPERACIONES=[
      'UBICACIÓN LUGAR Y DIRECCIÓN','RETOMA DE INSTALACIONES','RESCATE DE REHENES','PATRULLAJE','CONTROL DE LA POBLACIÓN.',
      'AISLAR EL ÁEREA','EMBOSCADA','GOLPE DE MANO','RECONOCIMIENTO','PERSECUCIÓN','DESTRUCCIÓN','INFILTRACIÓN','PLANEAMIENTO',
      'EVACUACIÓN','EXFILTRACIÓN','ENVIAR REFUERZOS','NOS ATACAN','ALISTAMIENTO','MOV. HELITRANSPORTAD','MOV. FLUVIAL',
      'MOV. POR VEHICULO TIE.','MOV. A PIE','MOV. ÁEREO','OP. AEROTRANSPORTADA','OP. DE INTELIGENCIA','OP. DE SEG.DIGNATARIOS',
      'OP. DE SEGURIDAD','OP. DE PPI','OP. CONTRAINTELIGENCIA','OP. HELITRANSPORTADA','OP. PSICOLÓGICAS','SECUESTRO','ABASTECIMIENTO',
      'EJERCICIO DE ENTRENAAMIENTO.','PLAN DE LLAMADAS','PRE ALERTA. ALERTA'
    ];
    const LUGARES=Array.from({length:48},(_,i)=>String(352+i));
    const PERSONALIDADES=['HA','HB','HC','HD','HE','HF','HG','HH','HI','HJ','HK','HL','HM','HN','HO','HP','HQ','HR','HS','HT','HU','HV','HW','HX','HY','HZ','H1','H2','H3','H4','H5','H11','H22','H33','H44','H55','HCF','HSM','HDP','HDF','HGU','HPU','HIA','HSP','HAE'];
    const UNIDADES=['0Y1','0Y2','0Y3','0Y4','0Y5','0Y6','0Y7','0Y8','0Y9'];
    const ACCIONES_OP=['KA','KB','KC','KD','KE','KF','KG','KH','KI','KJ','KK','KL','KN'];
    const MATERIAL=[...Array.from({length:26},(_,i)=>'L'+String.fromCharCode(65+i)),'L1','L2','L3','L4','L5','L6','L7'];
    const TRANSP=Array.from({length:14},(_,i)=>'Y'+(i+1));
    const OTROS=['O1','O2','O3','O4','O5','O6','O7','O8','O9','OX','OY','ODE','ON','OT','OF','OG','OC','OPM','OE','OID','OS','OR','OH','OM','ODO','ODR'];
    const TIPODOC=['Z1A','Z2B','Z3C','Z4D','Z5E','Z6F','Z7G','Z8H','Z9I','Z10J','Z11K','Z12L','Z13M','Z14N','Z15O','Z16P'];
    function fillSelect(sel, arr){ sel.innerHTML=''; arr.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); }

    // ===== Mapa & Agentes
    let map, agentsLayer, myMarker=null;
    function initMap(){
      if(map) return;
      map = L.map('map').setView([-16.5,-68.15], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
      agentsLayer = L.layerGroup().addTo(map);
      refreshAgents();
      setInterval(refreshAgents, 15000);
    }
    async function refreshAgents(){
      if(!getToken()||!map) return;
      try{
        const r = await fetch(`${API}/agents`,{headers:{'Authorization':'Bearer '+getToken()}});
        const data = await r.json(); if(!r.ok) throw new Error(data.message||'Err');
        agentsLayer.clearLayers();
        (data.agents||[]).forEach(a=>{
          if(typeof a.lat!=='number'||typeof a.lng!=='number') return;
          const icon=L.divIcon({className:'',html:`<div style="width:14px;height:14px;border-radius:50%;border:2px solid #fff;background:${colorHEX(a.color)}"></div>`});
          L.marker([a.lat,a.lng],{icon}).addTo(agentsLayer).bindPopup(`<b>${a.email}</b><br>${a.color}`);
        });
      }catch(_){}
    }
    function colorHEX(c){
      switch((c||'').toUpperCase()){
        case 'ROJO': return '#ef4444'; case 'AMARILLO': return '#f59e0b'; case 'VERDE': return '#22c55e';
        case 'AZUL': return '#3b82f6'; case 'NEGRO': return '#0f172a'; case 'BLANCO': return '#e5ecff';
        default: return '#94a3b8';
      }
    }

    // ===== Navegación
    function showOperativo(){ hide('panelAdmin'); show('panelOperativo'); window.scrollTo({top:0,behavior:'auto'}); }
    function showAdmin(){ hide('panelOperativo'); show('panelAdmin'); window.scrollTo({top:0,behavior:'auto'}); }

    // ===== Envío robusto / … (resto igual a tu archivo)
    // ------------- (todo tu JS existente se mantiene idéntico) -------------
    // (no toqué nada más de tu lógica)
  </script>

  <!-- Registrar Service Worker (añadido) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
